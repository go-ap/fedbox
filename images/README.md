## Container images

We are building podman[^1] container images for FedBOX that can be found at [quay.io](https://quay.io/go-ap/fedbox).

The containers are split onto two dimensions: 
* **Run Environment type**: `prod`, `qa` or `dev`:
  * `dev` images are built for every push, and they contain all debugging information
    and logging context possible. There is an additional caveat because the **HTTP-Signature**
    headers generated by them are not compatible with the [wider fediverse](https://pkg.go.dev/github.com/go-ap/client/s2s#HeadersToSign)
    in favour of supporting requests with the same signature being replayed.
  * `qa` images are also built for every push, but the binaries are stripped,
    and they contain less debugging and logging information.
  * `prod` images are similar to `qa` ones but are created only when a
* **Storage type**: `fs`, `sqlite`, `boltdb`, or including all. 
  * `fs` the JSON-Ld documents are saved verbatim on disk in a tree folder structure. Fast and error prone.
  * `sqlite`: the JSON-Ld documents are saved in a key-value store under the guise of a database table. 
Querying large collections could be slow.
  * `boltdb`: a more traditional key-value store in the Go ecosystem. 
  * ~~`badger`: another key-value store for the Go ecosystem. (unavailable at the moment)~~ 
  * If there isn't a storage option in the tag name, the image was built containing all the storage options,
    and requires the environment configuration to specify which one should be used.

A resulting image tag has information about all of these, and it would look like `qa-boltdb` 
(stripped image supporting boltdb storage), or `dev` (development image with all storage options available and
selectable through the configuration `.env` file).

Similarly, you shouldn't run the `latest` tag in production, because it usually points to a `dev` image and 
will not federate.

### Running a container

To run containers based on the image, use the following command.

```sh
# /var/cache/fedbox must exist and be writable as current user
# /var/cache/fedbox/env must be a valid env file as shown in the INSTALL document.
$ podman run --network=host --name=FedBOX -v /var/cache/fedbox/env:/.env -v /var/cache/fedbox:/storage --env-file=/var/cache/fedbox/env quay.io/go-ap/fedbox:latest
```

The `tools/run-container` script can also be used.

### Running `fedboxctl` commands in the containers

```sh
# running with the same configuration environment as above
$ podman exec --env-file=/var/cache/fedbox/env FedBOX fedboxctl bootstrap
$ podman exec --env-file=/var/cache/fedbox/env FedBOX fedboxctl pub actor add --type Application
Enter the actor's name: test
test's pw:
pw again:
Added "Application" [test]: https://fedbox/actors/22200000-0000-0000-0001-93e066611fcb
```

[^1] And docker, of course.

