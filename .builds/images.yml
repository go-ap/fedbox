image: archlinux
secrets:
- 3f30fd61-e33d-4198-aafb-0ff341e9db1c
packages:
  - podman
  - buildah
  - passt
  - go
sources:
  - https://git.sr.ht/~mariusor/fedbox
tasks:
  - setup: |
      test ${BUILD_SUBMITTER} != "git.sr.ht" && complete-build
      set -a +x
      source ~/.buildah.env

      _user=$(id -un)

      echo 'unqualified-search-registries = ["docker.io"]' | sudo tee /etc/containers/registries.conf.d/unq-search.conf

      echo "${_user}:10000:65536" | sudo tee /etc/subuid
      echo "${_user}:10000:65536" | sudo tee /etc/subgid

      podman system migrate

      systemctl --user start podman.service

      podman login -u="${BUILDAH_USER}" -p="${BUILDAH_SECRET}" quay.io

      cd fedbox || exit
      make download
  - fs: |
      cd fedbox || exit
      ./tools/build-images.sh push fs
  - boltdb: |
      cd fedbox || exit
      ./tools/build-images.sh push boltdb
  - badger: |
      cd fedbox || exit
      ./tools/build-images.sh push badger
  - sqlite: |
      cd fedbox || exit
      ./tools/build-images.sh push sqlite
